<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>HTML5本地存储之Web Storage篇</title>
</head>

<body>
    <div id="sign-in" style="border: 2px dashed #ccc; width:320px; text-align:center; margin: auto;">
        <label for="sitename">Username：</label>
        <input type="text" id="sitename" name="sitename" class="text" />
        <br />
        <label for="keyname">Password:</label>
        <input type="text" id="keyname" name="keyname" class="text" />
        <br />
        <!--<label for="siteurl">URL：</label>  
        <input type="text" id="siteurl" name="siteurl"/>  
        <br/>--><br />
        <input type="button" onclick="enter()" value="Login/Create Account" />
    </div>
    <br />
    <div id="list">
    </div>
    <script>
        function enter() {
            var site = new Object;
            site.sitename = document.getElementById("sitename").value;
            site.keyname = document.getElementById("keyname").value;
            if (site.sitename === "" || site.sitename === null) return alert("Fill in the username!");
            if (site.keyname === "" || site.keyname === null) return alert("Fill in the password!");
            // site.siteurl = document.getElementById("siteurl").value;
            if (localStorage.getItem("userPass")) {
                //if exist username already
                let items = localStorage.getItem("userPass");
                let newItems = JSON.parse("[" + items + `, {"user": "${site.sitename}", "pass": "${site.keyname}"}` + "]");
                let existingAccount = false;
                let existPassword = "";

                (JSON.parse(`[${items}]`)).forEach(e => {
                    if (e.user === site.sitename) {
                        existingAccount = true;
                        existPassword = e.pass;
                    }
                });

                if (existingAccount) {
                    if (site.keyname !== existPassword) return alert("This user exist. The password is incorrect.");
                    document.getElementById("keyname").value = '';
                    alert(`Successfully signed into ${site.sitename}`);
                    localStorage.setItem("currentAccount", site.sitename);
                } else {
                    localStorage.setItem(`userPass`, `${(JSON.stringify(newItems)).substring(1, JSON.stringify(newItems).length - 1)}`);
                    localStorage.setItem("currentAccount", site.sitename);
                }
            } else {
                localStorage.setItem(`userPass`, `{"user": "${site.sitename}", "pass": "${site.keyname}"}`);
                localStorage.setItem("currentAccount", site.sitename);
                alert("Account successfully created!");
            }


            document.getElementById("sitename").value = '';
            document.getElementById("keyname").value = '';
            //document.getElementById("siteurl").value = '';
            location.href = "index.html";
        }

        //将所有存储在localStorage中的对象提取出来，并展现到界面上
        // 确保存储的 keyname 对应的值为转换对象，否则JSON.parse会报错
        function loadAll() {
            var list = document.getElementById("list");
            if (localStorage.getItem("userPass").length > 0) {
                var result = "<table border='1'>";
                result += "<tr><td>Password</td><td>Username</td><td>网址</td></tr>";
                let items = localStorage.getItem("userPass");
                let itemsJSON = JSON.parse("[" + items + "]");
                itemsJSON.forEach(e => {
                    result += "<tr><td>" + e.pass + "</td><td>" + e.user + "</td><td>" + "" + "</td></tr>";
                });

                result += "</table>";
                list.innerHTML = result;
            } else {
                list.innerHTML = "No accounts created...";
            }
        }
    </script>
</body>

</html>